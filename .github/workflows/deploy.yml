name: 🚀 Deploy planes-solecloud

on:
  push:
    branches:
      - main
      - dev
      - qa

jobs:
  deploy:
    runs-on: self-hosted
    env:
      PORT: ${{ github.ref_name == 'main' && '7300' || github.ref_name == 'qa' && '7301' || github.ref_name == 'dev' && '7302' }}
      CONTAINER_NAME: ${{ github.ref_name == 'main' && 'planes-solecloud-prod' || github.ref_name == 'qa' && 'planes-solecloud-qa' || github.ref_name == 'dev' && 'planes-solecloud-dev' }}
    steps:
      # 1. Clonar el repositorio.
      - name: 📥 Clonar repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      # 2. Detener y eliminar contenedor existente
      - name: 🛑 Detener y eliminar contenedor anterior
        run: |
          docker stop ${CONTAINER_NAME} || true
          docker rm -f ${CONTAINER_NAME} || true

      # 3. Reconstruir y levantar contenedor
      - name: 🔨 Reconstruir y levantar contenedor
        run: |
          PORT=$PORT CONTAINER_NAME=$CONTAINER_NAME docker-compose up -d --build

      # 4. Mensaje final
      - name: ✅ Mensaje de confirmación
        if: success()
        run: echo "🚀 Deploy completado con éxito en ${{ github.ref_name }} (puerto $PORT)"

      - name: ❌ Mensaje de error
        if: failure()
        run: echo "❌ Falló el deploy en ${{ github.ref_name }}"
